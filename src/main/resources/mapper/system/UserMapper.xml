<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cc.mrbird.febs.system.mapper.UserMapper">
    <sql id="findUserDetailSql">
        SELECT
        u.user_id userId,
        u.username,
        u.email,
        u.mobile,
        u.status,
        u.create_time createTime,
        u.ssex sex,
        u.dept_id deptId,
        u.last_login_time lastLoginTime,
        u.modify_time modifyTime,
        u.description,
        u.avatar,
        u.unionid,
        u.active,
        u.order_in_depts,
        u.is_admin,
        u.is_boss,
        u.department,
        u.hired_date,
        u.is_senior,
        u.is_leader_in_depts,
        u.is_hide,
        u.position,
        u.jobnumber,
        d.dept_name deptName,
        u.school_id schoolId,
        GROUP_CONCAT(r.role_id) roleId,
        GROUP_CONCAT(r.ROLE_NAME) roleName
        FROM
        t_user u
        LEFT JOIN t_dept d ON (u.dept_id = d.dept_id)
        LEFT JOIN t_user_role ur ON (u.user_id = ur.user_id)
        LEFT JOIN t_role r ON r.role_id = ur.role_id
        WHERE 1 = 1
        <if test="user.username != null and user.username != ''">
            AND u.username = #{user.username}
        </if>
        <if test="user.deptId != null and user.deptId != ''">
            AND d.dept_id = #{user.deptId}
        </if>
        <if test="user.schoolId != null and user.schoolId != ''">
            AND u.school_id = #{user.schoolId}
        </if>
        <if test="user.sex != null and user.sex != ''">
            AND u.ssex = #{user.sex}
        </if>
        <if test="user.status != null and user.status != ''">
            AND u.status = #{user.status}
        </if>
        <if test="user.mobile != null and user.mobile != ''">
            AND u.mobile = #{user.mobile}
        </if>
        <if test="user.createTimeFrom != null and user.createTimeFrom !=''">
            And u.create_time &gt; #{user.createTimeFrom}
        </if>
        <if test="user.createTimeTo!= null and user.createTimeTo !=''">
            And u.create_time &lt; #{user.createTimeTo}
        </if>
        GROUP BY
        u.username,
        u.user_id,
        u.email,
        u.mobile,
        u.status,
        u.create_time,
        u.ssex,
        u.dept_id,
        u.school_id,
        u.last_login_time,
        u.modify_time,
        u.description,
        u.avatar,
        u.unionid,
        u.active,
        u.order_in_depts,
        u.is_admin,
        u.is_boss,
        u.department,
        u.hired_date,
        u.is_senior,
        u.is_leader_in_depts,
        u.is_hide,
        u.position,
        u.jobnumber
    </sql>
    <select id="findUserDetailPage" parameterType="user" resultType="user">
        <include refid="findUserDetailSql"/>
    </select>

    <select id="findUserDetail" parameterType="user" resultType="user">
        <include refid="findUserDetailSql"/>
    </select>

    <select id="findByName" parameterType="string" resultType="user">
        SELECT
        u.user_id userId,
        u.username,
        u.email,
        u.mobile,
        u.password,
        u.status,
        u.create_time createTime,
        u.ssex sex,
        u.dept_id deptId,
        u.last_login_time lastLoginTime,
        u.modify_time modifyTime,
        u.description,
        u.avatar,
        u.theme,
        u.is_tab isTab,
        u.school_id schoolId,
        d.dept_name deptName,
        u.unionid,
        u.active,
        u.order_in_depts,
        u.is_admin,
        u.is_boss,
        u.department,
        u.hired_date,
        u.is_senior,
        u.is_leader_in_depts,
        u.is_hide,
        u.position,
        u.jobnumber,
        GROUP_CONCAT(r.role_id) roleId,
        GROUP_CONCAT(r.ROLE_NAME) roleName
        FROM
        t_user u
        LEFT JOIN t_dept d ON (u.dept_id = d.dept_id)
        LEFT JOIN t_user_role ur ON (u.user_id = ur.user_id)
        LEFT JOIN t_role r ON r.role_id = ur.role_id
        WHERE  u.username = #{username}
        GROUP BY
        u.username,
        u.user_id,
        u.email,
        u.mobile,
        u.password,
        u.status,
        u.create_time,
        u.ssex,
        u.dept_id,
        u.school_id,
        u.last_login_time,
        u.modify_time,
        u.description,
        u.avatar,
        u.theme,
        u.unionid,
        u.active,
        u.order_in_depts,
        u.is_admin,
        u.is_boss,
        u.department,
        u.hired_date,
        u.is_senior,
        u.is_leader_in_depts,
        u.is_hide,
        u.position,
        u.jobnumber
    </select>

    <!--删除离职用户-->
    <delete id="deleteUser" parameterType="string">
        delete from t_user where user_id=#{userId}
    </delete>

    <!--新增用户-->
    <insert id="insertUser" parameterType="java.util.Map">
        insert into t_user(USER_ID,USERNAME,PASSWORD,DEPT_ID,EMAIL,MOBILE,STATUS,CREATE_TIME,MODIFY_TIME,LAST_LOGIN_TIME,
        SSEX,IS_TAB,THEME,AVATAR,DESCRIPTION,SCHOOL_ID,CLASS_ID,CONTACT,EMER_PHONE,RECENT_LOCATION,unionid,is_leader_in_depts,department
        ,is_boss,hired_date,is_senior,order_in_depts,active,is_admin,is_hide,jobnumber,position)
        values(#{userid},#{name},#{password},#{deptId},#{email},#{mobile},1,now(),now(),now(),
        1,1,'black',#{avatar},null,null,null,null,null,null,#{unionid},#{isLeaderInDepts}
        ,null,#{isBoss},from_unixtime(#{hiredDate}),#{isSenior},#{orderInDepts},#{active},#{isAdmin},#{isHide},#{jobnumber},#{position})
    </insert>

    <update id="updateUser" parameterType="java.util.Map">
        update t_user set username=#{name},password=#{password},dept_id=#{deptId},email=#{email},mobile=#{mobile},modify_time=now(),LAST_LOGIN_TIME=now(),
        AVATAR=#{avatar},unionid=#{unionid},is_leader_in_depts=#{isLeaderInDepts},is_boss=#{isBoss},hired_date=from_unixtime(#{hiredDate}),is_senior=#{isSenior},
        order_in_depts=#{orderInDepts},active=#{active},is_admin=#{isAdmin},is_hide=#{isHide},jobnumber=#{jobnumber},position=#{position}
        where user_id=#{userid}
    </update>
</mapper>
